"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/lib/authContext";
import { AuthModal } from "@/components/AuthModal";

type Product = {
  id: string;
  name: string;
  price: number;
  regularPrice?: number;
  discountPercent?: number | null;
  discountPrice?: number | null;
  imageUrl?: string | null;
};

type CartLine = {
  product: Product;
  quantity: number;
};

function isProduct(value: unknown): value is Product {
  if (!value || typeof value !== "object") return false;
  const v = value as Record<string, unknown>;
  return (
    typeof v.id === "string" &&
    typeof v.name === "string" &&
    typeof v.price === "number" &&
    Number.isFinite(v.price)
  );
}

function initialsFromName(name: string) {
  const parts = name
    .trim()
    .split(/\s+/)
    .filter(Boolean);
  const letters = parts.slice(0, 2).map((p) => p[0]?.toUpperCase()).filter(Boolean);
  return letters.join("") || "S";
}

function TrolleyIcon({ className }: { className?: string }) {
  return (
    <svg
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      aria-hidden="true"
      className={className}
    >
      <circle cx="9" cy="20" r="1" />
      <circle cx="17" cy="20" r="1" />
      <path d="M3 4h2l2.4 12.3a2 2 0 0 0 2 1.7h7.8a2 2 0 0 0 2-1.6L22 8H6" />
    </svg>
  );
}

// Currency formatter based on currency code
function formatPrice(price: number, currency: string = "AUD"): string {
  const currencySymbols: Record<string, string> = {
    AUD: "$",
    USD: "$",
    INR: "â‚¹",
    GBP: "Â£",
    EUR: "â‚¬",
  };
  const symbol = currencySymbols[currency] || "$";
  return `${symbol}${price.toFixed(2)}`;
}

function getCurrencyForCountry(country: string): string {
  const countryToCurrency: Record<string, string> = {
    AU: "AUD",
    IN: "INR",
    US: "USD",
    GB: "GBP",
    EU: "EUR",
  };
  return countryToCurrency[country?.toUpperCase() || "AU"] || "AUD";
}

export default function CartPageClient({ slug }: { slug: string }) {
  const tenant = slug.trim().toLowerCase();
  const apiBase = process.env.NEXT_PUBLIC_API_BASE_URL || "http://127.0.0.1:3001";
  const router = useRouter();
  const { user, isAuthenticated } = useAuth();

  type Store = { name?: string | null; phone?: string | null; themeColor?: string | null; currency?: string; country?: string };

  const [showAuthModal, setShowAuthModal] = useState(false);

  function cartStorageKey(currentTenant: string) {
    return `storegen:cart:${currentTenant}`;
  }

  function lastOrderStorageKey(currentTenant: string) {
    return `storegen:lastOrderId:${currentTenant}`;
  }

  function legacyCartStorageKey(currentTenant: string) {
    return `cart:${currentTenant}`;
  }

  function coerceCartRecord(value: unknown): Record<string, CartLine> {
    if (!value || typeof value !== "object") return {};

    const maybeRecord = value as Record<string, unknown>;
    const maybeItems = maybeRecord.items;
    if (Array.isArray(maybeItems)) {
      const next: Record<string, CartLine> = {};
      for (const item of maybeItems) {
        if (!item || typeof item !== "object") continue;
        const it = item as Record<string, unknown>;
        const product = it.product;
        const qty = Number(it.quantity ?? it.qty);
        if (!isProduct(product)) continue;
        if (!Number.isFinite(qty) || qty <= 0) continue;
        next[product.id] = { product, quantity: Math.floor(qty) };
      }
      return next;
    }

    const next: Record<string, CartLine> = {};
    for (const [productId, line] of Object.entries(maybeRecord)) {
      if (!line || typeof line !== "object") continue;
      const l = line as Record<string, unknown>;
      const product = l.product;
      const qty = Number(l.quantity);
      if (!isProduct(product)) continue;
      if (productId !== product.id) continue;
      if (!Number.isFinite(qty) || qty <= 0) continue;
      next[productId] = { product, quantity: Math.floor(qty) };
    }
    return next;
  }

  const [cart, setCart] = useState<Record<string, CartLine>>({});
  const [loadingCart, setLoadingCart] = useState(true);

  const [customerName, setCustomerName] = useState("");
  const [customerPhone, setCustomerPhone] = useState("");
  const [addressLine1, setAddressLine1] = useState("");
  const [city, setCity] = useState("");
  const [postalCode, setPostalCode] = useState("");
  const [country, setCountry] = useState("IN");
  const [deliverySlot, setDeliverySlot] = useState("Today 6-8pm");

  const [savedAddresses, setSavedAddresses] = useState<Array<{id: string; label: string; addressLine1: string; city: string; postalCode: string; state?: string; country: string; isDefault: boolean}>>([]);
  const [selectedAddressId, setSelectedAddressId] = useState<string | null>(null);
  const [showAddressForm, setShowAddressForm] = useState(false);
  const [savingAddress, setSavingAddress] = useState(false);

  const [placing, setPlacing] = useState(false);
  const [placingWhatsApp, setPlacingWhatsApp] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [store, setStore] = useState<Store | null>(null);
  const [selectedCountry, setSelectedCountry] = useState<string>("AU");
  const [showCountryMenu, setShowCountryMenu] = useState(false);

  const accent = store?.themeColor || undefined;
  const storeName = store?.name || "Cart";
  const logoText = initialsFromName(storeName);

  const cartLines = useMemo(() => Object.values(cart), [cart]);
  const cartItemCount = useMemo(
    () => cartLines.reduce((sum, l) => sum + l.quantity, 0),
    [cartLines]
  );
  const cartTotal = useMemo(
    () => cartLines.reduce((sum, l) => sum + l.product.price * l.quantity, 0),
    [cartLines]
  );

  useEffect(() => {
    if (user) {
      setCustomerName((prev) => prev || user.name || user.email?.split("@")[0] || "");
      setCustomerPhone((prev) => prev || user.phone || "");
      
      // Load saved addresses
      loadSavedAddresses();
    }
  }, [user]);

  const loadSavedAddresses = async () => {
    if (!user?.id) return;
    try {
      const res = await fetch(`${apiBase}/customers/${user.id}/addresses`, {
        headers: { "x-tenant-id": tenant },
      });
      if (res.ok) {
        const addresses = await res.json();
        setSavedAddresses(addresses);
        
        // Auto-select default address
        const defaultAddr = addresses.find((a: any) => a.isDefault);
        if (defaultAddr) {
          setSelectedAddressId(defaultAddr.id);
          setAddressLine1(defaultAddr.addressLine1);
          setCity(defaultAddr.city);
          setPostalCode(defaultAddr.postalCode);
          setCountry(defaultAddr.country || "IN");
        }
      }
    } catch (e) {
      console.error("Failed to load addresses:", e);
    }
  };

  const handleSelectAddress = (addressId: string) => {
    const addr = savedAddresses.find(a => a.id === addressId);
    if (addr) {
      setSelectedAddressId(addressId);
      setAddressLine1(addr.addressLine1);
      setCity(addr.city);
      setPostalCode(addr.postalCode);
      setCountry(addr.country || "IN");
      setShowAddressForm(false);
    }
  };

  const handleSaveNewAddress = async () => {
    if (!user?.id || !addressLine1.trim() || !city.trim() || !postalCode.trim()) {
      setError("Please fill in all address fields");
      return;
    }

    setSavingAddress(true);
    try {
      const res = await fetch(`${apiBase}/customers/${user.id}/addresses`, {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-tenant-id": tenant,
        },
        body: JSON.stringify({
          addressLine1: addressLine1.trim(),
          city: city.trim(),
          postalCode: postalCode.trim(),
          country: country.trim(),
          label: "Saved Address",
          isDefault: savedAddresses.length === 0,
        }),
      });

      if (res.ok) {
        const newAddr = await res.json();
        setSavedAddresses([...savedAddresses, newAddr]);
        setSelectedAddressId(newAddr.id);
        setShowAddressForm(false);
        setError(null);
      } else {
        setError("Failed to save address");
      }
    } catch (e) {
      setError("Error saving address");
      console.error(e);
    } finally {
      setSavingAddress(false);
    }
  };

  const checkoutIssues = useMemo(() => {
    const issues: string[] = [];
    if (cartLines.length === 0) issues.push("Add at least 1 item");
    if (!customerName.trim()) issues.push("Enter your name");
    if (!customerPhone.trim()) issues.push("Enter your phone");
    if (!addressLine1.trim()) issues.push("Enter your address");
    return issues;
  }, [cartLines.length, customerName, customerPhone, addressLine1]);

  const canProceedToPay = checkoutIssues.length === 0 && !placing && !placingWhatsApp;

  // Debug: Log checkout state changes
  useEffect(() => {
    console.log("Checkout state:", {
      canProceedToPay,
      issues: checkoutIssues,
      cartItemCount: cartLines.length,
      customerName: customerName.trim() ? "filled" : "EMPTY",
      customerPhone: customerPhone.trim() ? "filled" : "EMPTY",
      addressLine1: addressLine1.trim() ? "filled" : "EMPTY",
      placing,
      placingWhatsApp
    });
  }, [canProceedToPay, checkoutIssues, cartLines.length, customerName, customerPhone, addressLine1, placing, placingWhatsApp]);

  function whatsappPhone(): string | null {
    const raw = store?.phone || "";
    const digits = raw.replace(/[^0-9]/g, "");
    return digits ? digits : null;
  }

  function buildWhatsAppText(id?: string) {
    const lines: string[] = [];
    lines.push(`New order${id ? ` ${id}` : ""}`);
    lines.push("");

    for (const l of cartLines) {
      lines.push(`${l.product.name} x ${l.quantity} (â‚¹${l.product.price})`);
    }

    lines.push("");
    lines.push(`Total: â‚¹${cartTotal}`);
    if (deliverySlot.trim()) lines.push(`Delivery slot: ${deliverySlot.trim()}`);

    const cleanName = customerName.trim();
    const cleanPhone = customerPhone.trim();
    const cleanAddress = addressLine1.trim();
    if (cleanName) lines.push(`Name: ${cleanName}`);
    if (cleanPhone) lines.push(`Phone: ${cleanPhone}`);
    if (cleanAddress) lines.push(`Address: ${cleanAddress}`);
    const tail = [city.trim(), postalCode.trim(), country.trim()].filter(Boolean).join(", ");
    if (tail) lines.push(tail);

    return lines.join("\n");
  }

  function whatsappHref(id?: string): string | null {
    const phone = whatsappPhone();
    if (!phone) return null;
    return `https://wa.me/${phone}?text=${encodeURIComponent(buildWhatsAppText(id))}`;
  }

  function persist(nextCart: Record<string, CartLine>) {
    try {
      localStorage.setItem(cartStorageKey(tenant), JSON.stringify(nextCart));
    } catch {
      // ignore
    }
  }

  function clearCart() {
    setCart({});
    try {
      localStorage.removeItem(cartStorageKey(tenant));
    } catch {
      // ignore
    }
  }

  function addOne(productId: string) {
    setCart((prev) => {
      const existing = prev[productId];
      if (!existing) return prev;
      const next = { ...prev, [productId]: { ...existing, quantity: existing.quantity + 1 } };
      persist(next);
      return next;
    });
  }

  function removeOne(productId: string) {
    setCart((prev) => {
      const existing = prev[productId];
      if (!existing) return prev;
      const nextQty = existing.quantity - 1;
      let next: Record<string, CartLine>;
      if (nextQty <= 0) {
        next = { ...prev };
        delete next[productId];
      } else {
        next = { ...prev, [productId]: { ...existing, quantity: nextQty } };
      }
      persist(next);
      return next;
    });
  }

  useEffect(() => {
    setLoadingCart(true);
    setError(null);

    try {
      const primaryKey = cartStorageKey(tenant);
      const legacyKey = legacyCartStorageKey(tenant);

      const primaryRaw = localStorage.getItem(primaryKey);
      const legacyRaw = primaryRaw ? null : localStorage.getItem(legacyKey);

      const raw = primaryRaw ?? legacyRaw;
      if (!raw) {
        setCart({});
        return;
      }

      const parsed = JSON.parse(raw);
      const normalized = coerceCartRecord(parsed);
      setCart(normalized);

      if (!primaryRaw && legacyRaw) {
        try {
          localStorage.setItem(primaryKey, JSON.stringify(normalized));
          localStorage.removeItem(legacyKey);
        } catch {
          // ignore
        }
      }
    } catch {
      setCart({});
    } finally {
      setLoadingCart(false);
    }
  }, [tenant]);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const res = await fetch(`${apiBase}/store`, {
          headers: { "x-tenant-id": tenant },
          cache: "no-store",
        });
        const data = (await res.json().catch(() => null)) as Store | null;
        if (!cancelled) setStore(res.ok ? data : null);
      } catch {
        if (!cancelled) setStore(null);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [apiBase, tenant]);

  async function placeOrder(sendOnWhatsApp: boolean) {
    setError(null);

    if (cartLines.length === 0) {
      setError("Your cart is empty.");
      return;
    }

    const cleanName = customerName.trim();
    const cleanPhone = customerPhone.trim();
    const cleanAddress = addressLine1.trim();

    if (!cleanName || !cleanPhone || !cleanAddress) {
      setError("Please fill in: Name, Phone, and Address");
      console.warn("Validation failed:", { cleanName, cleanPhone, cleanAddress });
      return;
    }

    console.log("Starting placeOrder with:", { cleanName, cleanPhone, cleanAddress, cartItemCount: cartLines.length });

    if (sendOnWhatsApp) setPlacingWhatsApp(true);
    else setPlacing(true);

    try {
      if (isAuthenticated && user?.email) {
        try {
          await fetch(`${apiBase}/customers/link`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "x-tenant-id": tenant,
            },
            body: JSON.stringify({
              authUserId: user.id,
              email: user.email,
              name: cleanName,
              phone: cleanPhone,
            }),
          });
        } catch (e) {
          console.warn("Failed to link customer:", e);
        }
      }

      const res = await fetch(`${apiBase}/orders`, {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-tenant-id": tenant,
        },
        body: JSON.stringify({
          intent: sendOnWhatsApp ? "confirm" : "reserve",
          customerName: cleanName,
          customerPhone: cleanPhone,
          addressLine1: cleanAddress,
          city: city.trim() || undefined,
          postalCode: postalCode.trim() || undefined,
          country: country.trim() || undefined,
          deliverySlot: deliverySlot.trim() || undefined,
          items: cartLines.map((l) => ({
            productId: l.product.id,
            quantity: l.quantity,
          })),
        }),
      });

      const data = await res.json().catch(() => ({}));
      
      console.log("Order API response:", { status: res.status, data });
      
      if (!res.ok) {
        setError(data?.error || `Checkout failed (${res.status})`);
        console.error("Order creation failed:", data);
        return;
      }

      const orderId = String(data?.id || "");
      console.log("Order created successfully:", { orderId });

      try {
        if (orderId) localStorage.setItem(lastOrderStorageKey(tenant), orderId);
      } catch {
        // ignore
      }

      if (sendOnWhatsApp) {
        console.log("Sending via WhatsApp");
        clearCart();
        const href = whatsappHref(orderId);
        if (href) {
          try {
            window.open(href, "_blank", "noopener,noreferrer");
          } catch {
            // ignore
          }
        }
        setTimeout(() => {
          console.log("Navigating to order page:", `/s/${tenant}/order/${orderId}`);
          router.push(`/s/${encodeURIComponent(tenant)}/order/${encodeURIComponent(orderId)}`);
        }, 500);
        return;
      }

      // Clear cart before redirecting
      console.log("Clearing cart and navigating to payment page");
      clearCart();
      
      setTimeout(() => {
        const payUrl = `/s/${encodeURIComponent(tenant)}/pay/${encodeURIComponent(orderId)}`;
        console.log("Navigating to:", payUrl);
        router.push(payUrl);
      }, 300);
    } catch (e) {
      setError(e instanceof Error ? e.message : String(e));
    } finally {
      setPlacing(false);
      setPlacingWhatsApp(false);
    }
  }

  const directWhatsAppHref = whatsappHref();

  return (
    <main className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-purple-50/30">
      <AuthModal
        isOpen={showAuthModal}
        onClose={() => setShowAuthModal(false)}
        onSuccess={() => {
          if (user) {
            setCustomerName((prev) => prev || user.name || user.email?.split("@")[0] || "");
            setCustomerPhone((prev) => prev || user.phone || "");
          }
        }}
        tenant={tenant}
      />
      
      {/* Sticky Header */}
      <header className="sticky top-0 z-50 border-b border-foreground/10 bg-background/80 backdrop-blur">
        <div className="mx-auto flex w-full max-w-7xl items-center justify-between gap-4 px-4 py-4 sm:px-6 lg:px-8">
          <div className="flex items-center gap-3 min-w-0">
            <Link href={`/s/${encodeURIComponent(tenant)}`}>
              <div
                className="flex h-10 w-10 shrink-0 items-center justify-center rounded-2xl border border-foreground/10 font-bold text-xs shadow-sm"
                style={{ backgroundColor: accent }}
              >
                <span className="text-background">{logoText}</span>
              </div>
            </Link>
            <div className="min-w-0">
              <div className="text-lg font-bold tracking-tight">{storeName}</div>
              <div className="text-xs text-foreground/60 flex items-center gap-1.5">
                <TrolleyIcon className="h-3 w-3" />
                Checkout
              </div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <div className="text-right">
              <div className="text-sm font-semibold">{cartItemCount} items</div>
              <div className="text-xs text-foreground/60">â‚¹{cartTotal.toFixed(2)}</div>
            </div>
            <Link
              href={`/s/${encodeURIComponent(tenant)}`}
              className="inline-flex items-center justify-center rounded-lg border border-foreground/15 bg-background px-3 py-2 text-sm font-medium hover:bg-foreground/5 transition-colors"
            >
              Back
            </Link>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className="mx-auto max-w-6xl px-4 py-8 sm:px-6 lg:px-8">
        {error && (
          <div className="mb-6 rounded-lg border border-red-200/50 bg-red-50/50 p-4 backdrop-blur-sm">
            <div className="text-sm font-medium text-red-700">
              <span className="font-bold">Error:</span> {error}
            </div>
          </div>
        )}

        {loadingCart ? (
          <div className="flex items-center justify-center py-12">
            <div className="text-center">
              <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-foreground/10 border-t-foreground/40 mb-2"></div>
              <p className="text-foreground/60">Loading your cartâ€¦</p>
            </div>
          </div>
        ) : cartLines.length === 0 ? (
          <div className="rounded-xl border border-gray-200 bg-white p-8 text-center">
            <TrolleyIcon className="mx-auto h-12 w-12 text-gray-400 mb-4" />
            <h2 className="text-xl font-bold text-gray-900">Your cart is empty</h2>
            <p className="mt-2 text-sm text-gray-600">Start shopping to add items to your cart</p>
            <Link
              href={`/s/${encodeURIComponent(tenant)}`}
              className="mt-4 inline-flex items-center justify-center rounded-lg px-6 py-2 text-sm font-semibold text-white"
              style={{ backgroundColor: accent }}
            >
              Start Shopping
            </Link>
          </div>
        ) : (
          <div className="grid gap-6 lg:grid-cols-[1fr_400px]">
            {/* Left Column - Cart Items */}
            <div className="space-y-4">
              {/* Savings Banner */}
              {(() => {
                const totalSavings = cartLines.reduce((sum, l) => {
                  const regularPrice = typeof l.product.regularPrice === "number" ? l.product.regularPrice : l.product.price;
                  return sum + ((regularPrice - l.product.price) * l.quantity);
                }, 0);
                return totalSavings > 0 ? (
                  <div className="rounded-lg border-l-4 px-4 py-3" style={{ borderColor: accent, backgroundColor: `${accent}08` }}>
                    <div className="flex items-center gap-2">
                      <span className="text-lg font-bold text-green-600">ðŸ’°</span>
                      <div>
                        <p className="font-semibold text-gray-900">You're saving â‚¹{totalSavings.toFixed(2)}</p>
                        <p className="text-xs text-gray-600">Great deals on selected items</p>
                      </div>
                    </div>
                  </div>
                ) : null;
              })()}

              {/* Cart Items Section */}
              <div className="rounded-2xl border border-foreground/10 bg-background/50 backdrop-blur p-6 shadow-sm">
                <h2 className="text-lg font-bold mb-4">Order review</h2>
                <div className="space-y-4">
                  {cartLines.map((l, idx) => (
                    <div
                      key={l.product.id}
                      className={`flex gap-4 pb-4 ${idx < cartLines.length - 1 ? "border-b border-foreground/10" : ""}`}
                    >
                      {/* Product Image */}
                      <div className="flex-shrink-0">
                        <div className="h-24 w-24 overflow-hidden rounded-lg border border-gray-200 bg-gray-100">
                          {l.product.imageUrl ? (
                            // eslint-disable-next-line @next/next/no-img-element
                            <img
                              src={l.product.imageUrl}
                              alt={l.product.name}
                              className="h-full w-full object-cover"
                              loading="lazy"
                            />
                          ) : (
                            <div className="h-full w-full flex items-center justify-center bg-gray-200">
                              <span className="text-xs text-gray-400">No image</span>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Product Details */}
                      <div className="flex-1 flex flex-col justify-between min-w-0">
                        <div>
                          <h3 className="font-semibold text-gray-900 truncate">{l.product.name}</h3>
                          {typeof l.product.regularPrice === "number" && l.product.regularPrice !== l.product.price ? (
                            <div className="mt-1 flex items-center gap-2 flex-wrap">
                              <span className="font-bold text-green-600">â‚¹{l.product.price.toFixed(2)}</span>
                              {typeof l.product.discountPercent === "number" && l.product.discountPercent > 0 ? (
                                <span className="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-semibold text-red-800">
                                  Save {l.product.discountPercent.toFixed(0)}%
                                </span>
                              ) : null}
                              <span className="text-xs text-gray-500 line-through">â‚¹{l.product.regularPrice.toFixed(2)}</span>
                            </div>
                          ) : (
                            <p className="mt-1 text-sm font-semibold text-gray-900">â‚¹{l.product.price.toFixed(2)}</p>
                          )}
                        </div>
                        
                        {/* Quantity Controls */}
                        <div className="mt-2 flex items-center gap-3">
                          <div className="flex items-center border border-gray-300 rounded-lg">
                            <button
                              type="button"
                              onClick={() => removeOne(l.product.id)}
                              className="px-3 py-1.5 text-gray-700 hover:bg-gray-100 font-semibold text-lg"
                            >
                              âˆ’
                            </button>
                            <span className="px-4 py-1.5 font-semibold text-gray-900 min-w-12 text-center">
                              {l.quantity}
                            </span>
                            <button
                              type="button"
                              onClick={() => addOne(l.product.id)}
                              className="px-3 py-1.5 text-gray-700 hover:bg-gray-100 font-semibold text-lg"
                            >
                              +
                            </button>
                          </div>
                          <button
                            type="button"
                            onClick={() => removeOne(l.product.id)}
                            className="text-sm font-medium text-red-600 hover:text-red-800 underline"
                          >
                            Remove
                          </button>
                        </div>
                      </div>

                      {/* Line Total */}
                      <div className="flex-shrink-0 text-right">
                        <p className="text-lg font-bold text-gray-900">
                          â‚¹{(l.product.price * l.quantity).toFixed(2)}
                        </p>
                        <p className="mt-1 text-xs text-gray-500">
                          {l.quantity} Ã— â‚¹{l.product.price.toFixed(2)}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>

                <button
                  type="button"
                  onClick={clearCart}
                  className="mt-4 text-sm font-medium text-foreground/60 hover:text-red-600 transition-colors"
                >
                  Clear entire cart
                </button>
              </div>

              {/* Delivery Details Section */}
              <div className="rounded-2xl border border-foreground/10 bg-background/50 backdrop-blur p-6 shadow-sm">
                <h2 className="text-lg font-bold mb-6">Delivery details</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold mb-2">Full Name</label>
                    <input
                      value={customerName}
                      onChange={(e) => setCustomerName(e.target.value)}
                      placeholder="Enter your full name"
                      className="w-full rounded-lg border border-foreground/15 bg-background/80 backdrop-blur px-4 py-2.5 text-sm focus:border-foreground/30 focus:outline-none focus:ring-1 focus:ring-foreground/20"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-2">Phone Number</label>
                    <input
                      value={customerPhone}
                      onChange={(e) => setCustomerPhone(e.target.value)}
                      placeholder="Your mobile number"
                      className="w-full rounded-lg border border-foreground/15 bg-background/80 backdrop-blur px-4 py-2.5 text-sm focus:border-foreground/30 focus:outline-none focus:ring-1 focus:ring-foreground/20"
                    />
                  </div>

                  {/* Saved Addresses Section */}
                  {isAuthenticated && savedAddresses.length > 0 && !showAddressForm && (
                    <div>
                      <label className="block text-sm font-semibold mb-2">Select Saved Address</label>
                      <div className="space-y-2 mb-3">
                        {savedAddresses.map((addr) => (
                          <button
                            key={addr.id}
                            onClick={() => handleSelectAddress(addr.id)}
                            className={`w-full text-left p-3 rounded-lg border-2 transition-all ${
                              selectedAddressId === addr.id
                                ? "border-blue-500 bg-blue-50"
                                : "border-gray-200 bg-white hover:border-gray-300"
                            }`}
                          >
                            <div className="font-semibold text-sm text-gray-900">{addr.label}</div>
                            <div className="text-xs text-gray-600 mt-1">{addr.addressLine1}, {addr.city}, {addr.postalCode}</div>
                            {addr.isDefault && <div className="text-xs text-blue-600 font-semibold mt-1">âœ“ Default</div>}
                          </button>
                        ))}
                      </div>
                      <button
                        type="button"
                        onClick={() => setShowAddressForm(true)}
                        className="text-sm text-blue-600 hover:text-blue-700 font-semibold"
                      >
                        + Add New Address
                      </button>
                    </div>
                  )}

                  {/* Address Form */}
                  {!isAuthenticated || showAddressForm || savedAddresses.length === 0 ? (
                    <>
                      <div>
                        <label className="block text-sm font-semibold text-gray-900 mb-2">Delivery Address</label>
                        <input
                          value={addressLine1}
                          onChange={(e) => setAddressLine1(e.target.value)}
                          placeholder="Street address, building number, etc."
                          className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">City</label>
                          <input
                            value={city}
                            onChange={(e) => setCity(e.target.value)}
                            placeholder="City"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">Postal Code</label>
                          <input
                            value={postalCode}
                            onChange={(e) => setPostalCode(e.target.value)}
                            placeholder="ZIP / Postal code"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">Country</label>
                          <input
                            value={country}
                            onChange={(e) => setCountry(e.target.value)}
                            placeholder="Country"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                      </div>

                      {isAuthenticated && showAddressForm && (
                        <button
                          type="button"
                          onClick={handleSaveNewAddress}
                          disabled={savingAddress}
                          className="w-full bg-blue-100 text-blue-700 font-semibold py-2 rounded-lg hover:bg-blue-200 disabled:bg-gray-100 disabled:text-gray-500"
                        >
                          {savingAddress ? "Saving..." : "Save This Address"}
                        </button>
                      )}
                    </>
                  ) : (
                    <div>
                      <label className="block text-sm font-semibold text-gray-900 mb-2">Delivery Address</label>
                      <input
                        value={addressLine1}
                        onChange={(e) => setAddressLine1(e.target.value)}
                        placeholder="Street address, building number, etc."
                        className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                      />
                    </div>
                  )}

                  {!showAddressForm && savedAddresses.length > 0 && isAuthenticated && (
                    <>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">City</label>
                          <input
                            value={city}
                            onChange={(e) => setCity(e.target.value)}
                            placeholder="City"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">Postal Code</label>
                          <input
                            value={postalCode}
                            onChange={(e) => setPostalCode(e.target.value)}
                            placeholder="ZIP / Postal code"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">Country</label>
                          <input
                            value={country}
                            onChange={(e) => setCountry(e.target.value)}
                            placeholder="Country"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-900 mb-2">Delivery Slot</label>
                          <input
                            value={deliverySlot}
                            onChange={(e) => setDeliverySlot(e.target.value)}
                            placeholder="e.g., Today 6-8pm"
                            className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                          />
                        </div>
                      </div>
                    </>
                  )}

                  {showAddressForm && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-900 mb-2">Delivery Slot</label>
                      <input
                        value={deliverySlot}
                        onChange={(e) => setDeliverySlot(e.target.value)}
                        placeholder="e.g., Today 6-8pm"
                        className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                      />
                    </div>
                  )}

                  {(!isAuthenticated || (savedAddresses.length === 0 && !showAddressForm)) && (
                    <div>
                      <label className="block text-sm font-semibold text-gray-900 mb-2">Delivery Slot</label>
                      <input
                        value={deliverySlot}
                        onChange={(e) => setDeliverySlot(e.target.value)}
                        placeholder="e.g., Today 6-8pm"
                        className="w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm focus:border-gray-400 focus:outline-none focus:ring-1 focus:ring-gray-300"
                      />
                    </div>
                  )}

                  {checkoutIssues.length > 0 && (
                    <div className="rounded-lg border border-yellow-200 bg-yellow-50 p-3">
                      <p className="text-sm font-medium text-yellow-800">
                        To continue checkout, please:
                      </p>
                      <ul className="mt-2 space-y-1 text-xs text-yellow-700">
                        {checkoutIssues.map((issue, i) => (
                          <li key={i}>â€¢ {issue}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Right Column - Order Summary (Sticky) */}
            <div className="lg:sticky lg:top-24 lg:self-start space-y-4">
              {/* Authentication Banner */}
              {!isAuthenticated && (
                <div className="rounded-xl border-2 bg-gradient-to-br from-blue-50 to-indigo-50 p-5" style={{ borderColor: accent }}>
                  <div className="flex gap-3">
                    <span className="text-2xl">ðŸš€</span>
                    <div className="flex-1">
                      <h3 className="font-bold text-gray-900">Faster checkout</h3>
                      <p className="mt-1 text-xs text-gray-700">
                        Create an account to skip details on future orders and track your purchases.
                      </p>
                      <button
                        type="button"
                        onClick={() => setShowAuthModal(true)}
                        className="mt-3 w-full rounded-lg px-4 py-2 text-sm font-semibold text-white transition-all hover:shadow-lg"
                        style={{ backgroundColor: accent }}
                      >
                        Sign in or create account
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {isAuthenticated && (
                <div className="rounded-xl border border-green-200 bg-gradient-to-br from-green-50 to-emerald-50 p-4">
                  <div className="flex items-center gap-2">
                    <span className="text-lg">âœ“</span>
                    <div>
                      <p className="font-semibold text-green-900 text-sm">You're signed in</p>
                      <p className="text-xs text-green-700">Details pre-filled from your account</p>
                    </div>
                  </div>
                </div>
              )}

              {/* Order Summary Card */}
              <div className="rounded-2xl border border-foreground/10 bg-background/50 backdrop-blur p-6 shadow-sm">
                <h3 className="text-lg font-bold mb-4">Order summary</h3>
                
                <div className="space-y-3 pb-4 border-b border-foreground/10">
                  <div className="flex justify-between">
                    <span className="text-sm text-foreground/70">Subtotal</span>
                    <span className="font-semibold">
                      â‚¹{cartLines.reduce((sum, l) => {
                        const regularPrice = typeof l.product.regularPrice === "number" ? l.product.regularPrice : l.product.price;
                        return sum + (regularPrice * l.quantity);
                      }, 0).toFixed(2)}
                    </span>
                  </div>

                  {(() => {
                    const totalSavings = cartLines.reduce((sum, l) => {
                      const regularPrice = typeof l.product.regularPrice === "number" ? l.product.regularPrice : l.product.price;
                      return sum + ((regularPrice - l.product.price) * l.quantity);
                    }, 0);
                    return totalSavings > 0 ? (
                      <div className="flex justify-between">
                        <span className="text-sm text-foreground/70">Discount</span>
                        <span className="font-semibold" style={{ color: accent }}>-â‚¹{totalSavings.toFixed(2)}</span>
                      </div>
                    ) : null;
                  })()}

                  <div className="flex justify-between">
                    <span className="text-sm text-foreground/70">Delivery</span>
                    <span className="font-semibold">Free</span>
                  </div>
                </div>

                {/* Total */}
                <div className="mt-4 flex justify-between items-baseline">
                  <span className="font-bold">Total amount</span>
                  <span className="text-2xl font-bold" style={{ color: accent }}>
                    â‚¹{cartTotal.toFixed(2)}
                  </span>
                </div>

                <p className="mt-3 text-xs text-foreground/60">
                  âœ“ Taxes included â€¢ âœ“ Delivery subject to availability
                </p>

                {/* Checkout Buttons */}
                <div className="mt-6 space-y-3">
                  <button
                    type="button"
                    onClick={() => {
                      console.group("PAY BUTTON CLICKED");
                      console.log("Current state:", {
                        canProceedToPay,
                        issues: checkoutIssues,
                        customerName: `"${customerName}" (trimmed: "${customerName.trim()}")`,
                        customerPhone: `"${customerPhone}" (trimmed: "${customerPhone.trim()}")`,
                        addressLine1: `"${addressLine1}" (trimmed: "${addressLine1.trim()}")`,
                        cartItems: cartLines.length,
                        placing,
                        placingWhatsApp
                      });
                      console.groupEnd();
                      if (canProceedToPay) {
                        placeOrder(false);
                      } else {
                        console.warn("Button disabled - cannot proceed to pay");
                      }
                    }}
                    disabled={!canProceedToPay}
                    className="w-full rounded-lg px-4 py-3.5 text-sm font-bold text-white transition-all duration-200 hover:shadow-xl hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                    style={{
                      background: accent ? `linear-gradient(135deg, ${accent}, ${accent}dd)` : 'linear-gradient(135deg, #0A7C2F, #065A23)',
                      boxShadow: accent ? `0 4px 20px ${accent}40` : '0 4px 20px #0A7C2F40'
                    }}
                    title={!canProceedToPay ? checkoutIssues.join(", ") : "Proceed to payment"}
                  >
                    {placing ? (
                      <span className="flex items-center justify-center gap-2">
                        <svg className="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                        </svg>
                        Processing order...
                      </span>
                    ) : (
                      <span className="flex items-center justify-center gap-2">
                        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm4.768 11.881l-6 6a.75.75 0 0 1-1.06 0l-3-3a.75.75 0 1 1 1.06-1.06L9.75 16.19l5.47-5.47a.75.75 0 1 1 1.06 1.06z" />
                        </svg>
                        Pay â‚¹{cartTotal.toFixed(2)}
                      </span>
                    )}
                  </button>

                  <button
                    type="button"
                    onClick={() => placeOrder(true)}
                    disabled={placing || placingWhatsApp || !directWhatsAppHref}
                    className="w-full rounded-lg px-4 py-3 text-sm font-bold transition-all duration-200 hover:shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                    style={{
                      backgroundColor: accent ? `${accent}15` : '#0A7C2F15',
                      color: accent || '#0A7C2F',
                      border: `2px solid ${accent || '#0A7C2F'}`
                    }}
                  >
                    {placingWhatsApp ? (
                      <span className="flex items-center justify-center gap-2">
                        <svg className="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                        </svg>
                        Opening WhatsApp...
                      </span>
                    ) : (
                      <span className="flex items-center justify-center gap-2">
                        <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L2 22l6.29-.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm0 18c-1.41 0-2.73-.36-3.88-.99l-.28-.15-2.89.44.44-2.89-.15-.28C4.36 14.73 4 13.41 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm3.97-5.29c-.22-.12-1.31-.65-1.52-.72-.21-.08-.36-.12-.51.12-.15.24-.58.72-.71.87-.13.15-.26.17-.48.05-1.66-.83-2.73-1.51-3.81-3.47-.28-.48.28-1.44.62-1.91.07-.1.1-.25.05-.4-.05-.15-.5-1.2-.68-1.64-.17-.44-.35-.38-.48-.38-.12 0-.26 0-.4 0-.14 0-.37.05-.56.24-.2.2-.75.73-.75 1.79 0 1.06.77 2.07 1.27 2.8.5.74 2.87 4.35 6.93 6.09.97.43 1.73.68 2.32.87.97.31 1.85.27 2.55.16.78-.11 2.41-1 2.75-1.96.34-.95.34-1.77.24-1.96-.1-.19-.25-.31-.51-.43z" />
                        </svg>
                        WhatsApp
                      </span>
                    )}
                  </button>

                  <button
                    type="button"
                    onClick={() => router.push(`/s/${encodeURIComponent(tenant)}`)}
                    className="w-full rounded-lg px-4 py-2.5 text-sm font-semibold text-foreground/70 border border-foreground/15 bg-background hover:bg-foreground/5 transition-all duration-200"
                  >
                    Cancel
                  </button>

                  {directWhatsAppHref && (
                    <a
                      href={directWhatsAppHref}
                      target="_blank"
                      rel="noreferrer"
                      className="block text-center text-xs font-medium text-foreground/60 hover:text-foreground/90 py-2 hover:underline transition-colors"
                    >
                      Send cart without checkout
                    </a>
                  )}
                </div>

                {!directWhatsAppHref && (
                  <p className="mt-4 text-xs text-foreground/60 text-center">
                    WhatsApp option not available (store not configured)
                  </p>
                )}
              </div>

              {/* Trust Elements */}
              <div className="rounded-2xl border border-foreground/10 bg-background/50 backdrop-blur p-4">
                <div className="space-y-3 text-xs text-foreground/70">
                  <div className="flex items-start gap-2">
                    <span className="text-base leading-none mt-0.5">ðŸ”’</span>
                    <span>Secure checkout with encrypted payment</span>
                  </div>
                  <div className="flex items-start gap-2">
                    <span className="text-base leading-none mt-0.5">ðŸ“¦</span>
                    <span>Fast delivery to your address</span>
                  </div>
                  <div className="flex items-start gap-2">
                    <span className="text-base leading-none mt-0.5">â†©ï¸</span>
                    <span>Easy returns and exchanges</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </main>
  );
}
